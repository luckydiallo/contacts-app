name: CI/CD Pipeline (Frontend + Backend)

on:
  push:
    branches: ['main']
  workflow_dispatch:

env:
  REGISTRY_USER: belcodiallo
  REGISTRY: docker.io
  IMAGE_BACKEND: belcodiallo/myapp-backend
  IMAGE_FRONTEND: belcodiallo/myapp-frontend
  # Déploiements & conteneurs K8s!
  K8S_NAMESPACE: default
  DEPLOY_BACKEND: contact-app-backend
  DEPLOY_FRONTEND: contact-app-frontend
  CONTAINER_BACKEND: backend
  CONTAINER_FRONTEND: frontend
  # Tag lisible + immuable
  IMG_TAG: ${{ github.run_number }}
  IMG_SHA: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17 (backend)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build JAR with Maven
        run: mvn -B package -Dmaven.test.skip=true --file pom.xml

      - name: Set up Node 18 (frontend)
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build frontend (prod)
        working-directory: frontend
        run: |
          npm ci
          npm run build --if-present --prod

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.REGISTRY_USER }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # Backend
      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_BACKEND }}:${{ env.IMG_TAG }}
            ${{ env.IMAGE_BACKEND }}:latest
          build-args: |
            JAR_FILE=target/*.jar
          cache-from: type=registry,ref=${{ env.IMAGE_BACKEND }}:latest
          cache-to: type=inline

      # Frontend
      - name: Build & push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_FRONTEND }}:${{ env.IMG_TAG }}
            ${{ env.IMAGE_FRONTEND }}:latest
          cache-from: type=registry,ref=${{ env.IMAGE_FRONTEND }}:latest
          cache-to: type=inline

  deploy:
    runs-on: self-hosted
    needs: [build-and-push]
    environment: production
    steps:
      - name: Vérifier le cluster
        run: kubectl get nodes -o wide

      - name: Déployer BACKEND (rolling update)
        env:
          IMG: ${{ env.IMAGE_BACKEND }}:${{ env.IMG_TAG }}
        run: |
          # Affiche les conteneurs actuels pour t'aider à valider les noms
          kubectl get deploy $DEPLOY_BACKEND -n $K8S_NAMESPACE -o=jsonpath='{.spec.template.spec.containers[*].name}{"\n"}' || true

          kubectl set image deployment/$DEPLOY_BACKEND \
            $CONTAINER_BACKEND=$IMG \
            -n $K8S_NAMESPACE

          kubectl rollout status deployment/$DEPLOY_BACKEND -n $K8S_NAMESPACE --timeout=180s
          kubectl rollout history deployment/$DEPLOY_BACKEND -n $K8S_NAMESPACE

      - name: Déployer FRONTEND (rolling update)
        env:
          IMG: ${{ env.IMAGE_FRONTEND }}:${{ env.IMG_TAG }}
        run: |
          kubectl get deploy $DEPLOY_FRONTEND -n $K8S_NAMESPACE -o=jsonpath='{.spec.template.spec.containers[*].name}{"\n"}' || true

          kubectl set image deployment/$DEPLOY_FRONTEND \
            $CONTAINER_FRONTEND=$IMG \
            -n $K8S_NAMESPACE

          kubectl rollout status deployment/$DEPLOY_FRONTEND -n $K8S_NAMESPACE --timeout=180s
          kubectl rollout history deployment/$DEPLOY_FRONTEND -n $K8S_NAMESPACE
